<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload XLSX</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.sheetjs.com/xlsx-0.19.1/package/dist/xlsx.full.min.js"></script>
    <link href="./css/style.css" rel="stylesheet">
</head>
<body>

<div class="container py-5">
    <!-- Formulaire d'upload -->
    <form method="post" action="/upload-xlsx" enctype="multipart/form-data" class="mb-4">
        <div class="mb-3">
            <label for="xls" class="form-label">Choisissez un fichier :</label>
            <input type="file" name="xls" id="xls" class="form-control" accept=".xls, .xlsx, .csv" required>
        </div>
        <button type="submit" class="btn btn-primary">Uploader</button>
    </form>

    <!-- Aperçu des options -->
    <section>
        <h3 class="mb-4">Aperçu</h3>

        <div class="row g-3 mb-4">
            <div class="col-md-4">
                <label for="selectParametre" class="form-label">Paramètre :</label>
                <select name="selectParametre" id="selectParametre" class="form-select">
                </select>
            </div>
            <div class="col-md-4">
                <label for="selectZone" class="form-label">Zone :</label>
                <select name="selectZone" id="selectZone" class="form-select">
                </select>
            </div>
            <div class="col-md-4">
                <label for="selectVisage" class="form-label">Visage :</label>
                <select name="selectVisage" id="selectVisage" class="form-select">
                </select>
            </div>
        </div>

        <div id="result" class="p-3 border bg-light">
            <!-- Contenu prévisualisé -->
        </div>
    </section>
</div>

<script>
    // fonction qui renvoie les valeurs d'une colonne donnée d'indice (indice) dans un tableau 2D (tab) avec élimination des valeurs vides
    function recuperationValeursVariable(tab, indice) {
        var tabResult = [];
        tab.forEach(ligne => {
            if (ligne[indice] != null && ligne[indice] != 1000 && ligne[indice] != "" && ligne[indice] != 0 && ligne[indice] != undefined) {
                tabResult.push(ligne[indice]);
            }
        });
        return tabResult;
    }

    var inputFile = document.getElementById("xls");
    function previewXLSFile(e) {
        var file = e.target.files[0];
        var reader = new FileReader();
        reader.onload = function (e) {
            var data = e.target.result;
            var workbook = XLSX.read(data, { type: 'array' });
            var firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            var result = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

            var listeEntete = result[1].filter(f => { return f != null });

            var listeParametre = [];
            var listeVisage = [];
            var listeZone = [];
            for (var i = 4; i < listeEntete.length; i++) {
                var listeTermVariable = listeEntete[i].split('_');
                if (listeParametre.indexOf(listeTermVariable[0]) == -1) {
                    listeParametre.push(listeTermVariable[0]);
                }
                if (listeVisage.indexOf(listeTermVariable[listeTermVariable.length - 1]) == -1) {
                    listeVisage.push(listeTermVariable[listeTermVariable.length - 1]);
                }
                if (listeTermVariable.length == 3) {
                    if (listeZone.indexOf(listeTermVariable[1]) == -1) {
                        listeZone.push(listeTermVariable[1]);
                    }
                }
            }

            remplirSelect("selectParametre", listeParametre);
            remplirSelect("selectZone", listeZone);
            remplirSelect("selectVisage", listeVisage);

            var output = document.getElementById('result');
            output.innerHTML = JSON.stringify(recuperationValeursVariable(result, 0), null, 2);
        };
        reader.readAsArrayBuffer(file);
    }

    inputFile.addEventListener("change", previewXLSFile, false);

    function remplirSelect(idSelect, listeOption) {
        var divSelect = document.querySelector("#" + idSelect);
        listeOption.forEach(option => {
            var optionHTML = document.createElement("option");
            optionHTML.value = option;
            optionHTML.innerHTML = option;
            divSelect.appendChild(optionHTML);
        });
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
