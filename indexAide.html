<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Visualization Interactive</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/simple-statistics@7.8.0/dist/simple-statistics.min.js"></script>
    <script src="https://unpkg.com/@sgratzl/chartjs-chart-boxplot@3.10.0/build/index.umd.min.js"></script>
    <style>
        canvas {
            -moz-user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
        }
        table td {
            border: 1px solid black;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Zone de sélection -->
        <div class="row">
            <div id="filter-section" class="col-12 col-lg-3 mb-3">
                <div class="p-3 border">
                    <label for="file-input" class="form-label">Choisissez un fichier Excel :</label>
                    <input type="file" id="file-input" class="form-control mb-3" accept=".xls, .xlsx, .csv">

                    <label for="filter-zone-select">Choisissez une zone :</label>
                    <select id="filter-zone-select" class="form-select mb-3"></select>

                    <label for="filter-variable-select">Choisissez une variable :</label>
                    <select id="filter-variable-select" class="form-select mb-3"></select>

                    <label for="filter-visage-select">Choisissez un visage :</label>
                    <select id="filter-visage-select" class="form-select mb-3"></select>

                    <label for="filter-age-split">Séparation par âge :</label>
                    <select id="filter-age-split" class="form-select mb-3"></select>

                    <div id="filter-images" class="text-center">
                        <!-- Images dynamiques selon sélection -->
                    </div>
                </div>
            </div>

            <!-- Accordéon Bootstrap -->
            <div class="col-12 col-lg-9">
                <div class="accordion" id="data-accordion">
                    <!-- Visualisation par âge -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="accordion-age-heading">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#accordion-age-collapse" aria-expanded="true" aria-controls="accordion-age-collapse">
                                Visualisation par âge
                            </button>
                        </h2>
                        <div id="accordion-age-collapse" class="accordion-collapse collapse show" aria-labelledby="accordion-age-heading" data-bs-parent="#data-accordion">
                            <div class="accordion-body">
                                <div class="row">
                                    <div class="col-12 col-lg-6">
                                        <canvas id="chart-age-1"></canvas>
                                    </div>
                                    <div class="col-12 col-lg-6">
                                        <canvas id="chart-age-2"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Visualisation par paramètre -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="accordion-param-heading">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#accordion-param-collapse" aria-expanded="false" aria-controls="accordion-param-collapse">
                                Visualisation par paramètre
                            </button>
                        </h2>
                        <div id="accordion-param-collapse" class="accordion-collapse collapse" aria-labelledby="accordion-param-heading" data-bs-parent="#data-accordion">
                            <div class="accordion-body">
                                <div class="row">
                                    <div class="col-12 col-lg-6">
                                        <div id="summary-stats-table"></div>
                                    </div>
                                    <div class="col-12 col-lg-6">
                                        <canvas id="chart-param"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Visualisation globale -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="accordion-global-heading">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#accordion-global-collapse" aria-expanded="false" aria-controls="accordion-global-collapse">
                                Visualisation globale
                            </button>
                        </h2>
                        <div id="accordion-global-collapse" class="accordion-collapse collapse" aria-labelledby="accordion-global-heading" data-bs-parent="#data-accordion">
                            <div class="accordion-body">
                                <div class="row mb-4">
                                    <div class="col-12 col-lg-6">
                                        <canvas id="chart-global-1"></canvas>
                                    </div>
                                    <div class="col-12 col-lg-6">
                                        <canvas id="chart-global-2"></canvas>
                                    </div>
                                </div>
                                <div class="row mb-4">
                                    <div class="col-12 col-lg-6">
                                        <canvas id="chart-global-3"></canvas>
                                    </div>
                                    <div class="col-12 col-lg-6">
                                        <canvas id="chart-global-4"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        var fileInput = document.getElementById("file-input");
        var result;
        var tabTSA, tabDT;

        fileInput.addEventListener("change", function(e) {
            var file = e.target.files[0];
            var reader = new FileReader();
            reader.onload = function(e) {
                var data = e.target.result;
                var workbook = XLSX.read(data, { type: "array" });
                var firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                result = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                var listeParametre = [];
                var listeZone = [];
                var listeVisage = [];

                var listeEntete = result[1].filter((f) => f != null);
                for (var i = 4; i < listeEntete.length; i++) {
                    var listeTermVariable = listeEntete[i].split("_");
                    if (!listeParametre.includes(listeTermVariable[0])) listeParametre.push(listeTermVariable[0]);
                    if (listeTermVariable.length > 1 && !listeZone.includes(listeTermVariable[1])) listeZone.push(listeTermVariable[1]);
                    if (!listeVisage.includes(listeTermVariable[listeTermVariable.length - 1])) listeVisage.push(listeTermVariable[listeTermVariable.length - 1]);
                }

                remplirSelect("filter-variable-select", listeParametre);
                remplirSelect("filter-zone-select", listeZone);
                remplirSelect("filter-visage-select", listeVisage);

                var ageMin = Math.min(...recuperationValeursVariable(result, result[1].indexOf("Age (ans)")));
                var ageMax = Math.max(...recuperationValeursVariable(result, result[1].indexOf("Age (ans)")));
                var ages = Array.from({ length: ageMax - ageMin - 1 }, (_, i) => ageMin + i + 1);
                remplirSelect("filter-age-split", ages);

                tabTSA = result.filter(row => row[result[1].indexOf("Case")] === "TSA");
                tabDT = result.filter(row => row[result[1].indexOf("Case")] === "DT");

                setupEventListeners();
            };
            reader.readAsArrayBuffer(file);
        });

        function remplirSelect(id, options) {
            var select = document.getElementById(id);
            select.innerHTML = "";
            options.forEach((opt) => {
                var option = document.createElement("option");
                option.value = opt;
                option.textContent = opt;
                select.appendChild(option);
            });
        }

        function recuperationValeursVariable(tab, indice) {
            return tab.map((row) => row[indice]).filter((val) => val != null && val !== "");
        }

        function setupEventListeners() {
            document.getElementById("filter-zone-select").addEventListener("change", afficheDataVis);
            document.getElementById("filter-variable-select").addEventListener("change", afficheDataVis);
            document.getElementById("filter-visage-select").addEventListener("change", afficheDataVis);
            document.getElementById("filter-age-split").addEventListener("change", afficheDataVis);
        }

        function afficheDataVis() {
            var indVarSel = document.getElementById("filter-variable-select").selectedIndex;
            var indZoneSel = document.getElementById("filter-zone-select").selectedIndex;
            var indVisageSel = document.getElementById("filter-visage-select").selectedIndex;
            var splitAge = parseInt(document.getElementById("filter-age-split").value);

            var tabDTVarSel = recuperationValeursVariable(tabDT, indVarSel);
            var tabTSAVarSel = recuperationValeursVariable(tabTSA, indVarSel);

            var ageColIndex = result[1].indexOf("Age (ans)");
            var tabDTCatAge1 = tabDT.filter(row => row[ageColIndex] <= splitAge);
            var tabDTCatAge2 = tabDT.filter(row => row[ageColIndex] > splitAge);
            var tabTSACatAge1 = tabTSA.filter(row => row[ageColIndex] <= splitAge);
            var tabTSACatAge2 = tabTSA.filter(row => row[ageColIndex] > splitAge);

            // Update charts
            updateCharts(tabDTVarSel, tabTSAVarSel, tabDTCatAge1, tabDTCatAge2, tabTSACatAge1, tabTSACatAge2);
        }

        function updateCharts(tabDTVarSel, tabTSAVarSel, tabDTCatAge1, tabDTCatAge2, tabTSACatAge1, tabTSACatAge2) {
            // Example: Update the first age chart
            var ctx1 = document.getElementById("chart-age-1").getContext("2d");
            new Chart(ctx1, {
                type: "line",
                data: {
                    labels: Array.from({ length: tabDTVarSel.length }, (_, i) => i + 1),
                    datasets: [
                        { label: "DT", data: tabDTVarSel, borderColor: "red", fill: false },
                        { label: "TSA", data: tabTSAVarSel, borderColor: "blue", fill: false }
                    ]
                }
            });

            // Additional charts can be updated similarly
        }
    </script>
</body>
</html>